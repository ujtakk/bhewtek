module top(/*AUTOARG*/);
`include "parameters.vh"
<%- load "parameters.rb" -%>

  /*AUTOINPUT*/

  /*AUTOOUTPUT*/

  /*AUTOWIRE*/

  /*AUTOREG*/

  // AUTO_CONSTANT (DWIDTH)

  /* sram_input AUTO_TEMPLATE (
      .read_data  (read_input[DWIDTH-1:0]),
      .write_data (write_input[DWIDTH-1:0]),
      .mem_we     (input_we),
      .mem_addr   (mem_input_addr[INSIZE-1:0]),
  ); */
  sram_input mem_input(/*AUTOINST*/);

  /* decoder AUTO_TEMPLATE (
      .in_code  (weight_we[<%=$core_log%>:0]),
      .out_code (mem_weight_we[<%=$core-1%>:0]),
  ); */
  decoder dec_weight(/*AUTOINST*/);

  <%- for i in 0...$core -%>
  /* sram_weight AUTO_TEMPLATE (
      .read_data  (read_weight<%=i%>[DWIDTH-1:0]),
      .write_data (write_weight[DWIDTH-1:0]),
      .mem_we     (mem_weight_we[<%=i%>]),
      .mem_addr   (mem_weight_addr[WSIZE-1:0]),
  ); */
  sram_weight mem_weight<%=i%>(/*AUTOINST*/);
  <%- end -%>

%if $old
  /* linebuf_pix AUTO_TEMPLATE (
      .read_data (read_input[DWIDTH-1:0]),
  ); */
  linebuf_pix buf_pix(/*AUTOINST*/);
%else
  /* linebuf AUTO_TEMPLATE (
      .buf_en     (buf_pix_en),
      .buf_input  (read_input[DWIDTH-1:0]),
      .img_size (img_size[LWIDTH-1:0]),
      .fil_size (fil_size[LWIDTH-1:0]),
      <%- for i in 0...$fsize -%>
      <%-   for j in 0...$fsize -%>
      .buf_output<%=i%>_<%=j%> (pixel<%=i*$fsize+j%>[DWIDTH-1:0]),
      <%-   end -%>
      <%- end -%>
  ); */
  linebuf buf_pix(/*AUTOINST*/);
%end

  newctrl ctrl(/*AUTOINST*/);

  <%- for i in 0...$core -%>
  /* core AUTO_TEMPLATE (
      .conv_we          (conv_we),
      .mem_feat_addr    (mem_feat_addr[FACCUM-1:0]),
      .mem_feat_addr_d1 (mem_feat_addr_d1[FACCUM-1:0]),
      .mem_feat_rst     (mem_feat_rst),
      .mem_feat_we      (mem_feat_we),
      .pool_we          (pool_we),
      .read_weight      (read_weight<%=i%>[DWIDTH-1:0]),
      .wreg_we          (wreg_we),
      .pmap             (pmap<%=i%>[DWIDTH-1:0]),
  ); */
  core core<%=i%>(/*AUTOINST*/);
  <%- end -%>

  <%- for i in 0...$core -%>
  /* sram_output AUTO_TEMPLATE (
      .read_data  (read_output<%=i%>[DWIDTH-1:0]),
      .write_data (pmap<%=i%>[DWIDTH-1:0]),
      .mem_we     (mem_output_we),
      .mem_addr   (mem_output_addr[OUTSIZE-1:0]),
  ); */
  sram_output mem_output<%=i%>(/*AUTOINST*/);
  <%- end -%>

  mux_output select_out(/*AUTOINST*/);

endmodule

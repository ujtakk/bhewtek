module linebuf_feat(/*AUTOARG*/);
`include "parameters.vh"
<%- load "parameters.rb" -%>

    /*AUTOINPUT*/
    input clk;
    input [DWIDTH-1:0] read_data;

    /*AUTOOUTPUT*/
    <%- for i in 0..$psize**2-1 -%>
    output [DWIDTH-1:0] pixel_feat<%=i%>;
    <%- end -%>

    /*AUTOWIRE*/

    /*AUTOREG*/

    <%- for y in 0..$psize-1 -%>
    <%-   x_max = y == $psize-1 ? $psize-1 : $insize-1 -%>
    <%-   for x in 0..x_max -%>
    reg [DWIDTH-1:0]    r_pix<%=y%>_<%=x%>;
    <%-   end -%>
    <%- end -%>

    <%- for i in 0..$psize**2-1 -%>
    assign pixel_feat<%=i%> = r_pix<%=i/2%>_<%=i%2%>;
    <%- end -%>

    <%- for y in 0..$psize-1 -%>
    <%-   x_max = y == $psize-1 ? $psize-1 : $insize-1 -%>
    <%-   for x in 0..x_max -%>
    always @(posedge clk)
        <%- if x == x_max -%>
        <%-   if y == $psize-1 -%>
        r_pix<%=y%>_<%=x%> <= read_data;
        <%-   else -%>
        r_pix<%=y%>_<%=x%> <= r_pix<%=y+1%>_0;
        <%-   end -%>
        <%- else -%>
        r_pix<%=y%>_<%=x%> <= r_pix<%=y%>_<%=x+1%>;
        <%- end -%>
    <%-   end -%>
    <%- end -%>

endmodule

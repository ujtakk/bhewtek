module ctrl(/*AUTOARG*/);
`include "parameters.vh"
<%- load "parameters.rb" -%>

    parameter WAIT = 'd0;
    parameter WREG = 'd1;
    parameter CONV = 'd2;
    parameter POOL = 'd3;

    /*AUTOINPUT*/
    input clk;
    input xrst;
    input req;
    input [INSIZE-1:0] in_addr;
    input [WSIZE-1:0]  w_addr;
    input [LWIDTH-1:0] n_in;
    input [LWIDTH-1:0] n_out;
    input [LWIDTH-1:0] img_w;
    input [LWIDTH-1:0] img_h;
    input [LWIDTH-1:0] fil_w;
    input [LWIDTH-1:0] fil_h;

    /*AUTOOUTPUT*/
    output [INSIZE-1:0] mem_input_addr;
    output ack;
    <%- for i in 0...$core -%>
    output [WSIZE-1:0] mem_weight_addr<%=i%>;
    output wreg_we<%=i%>;
    output mem_feat_we<%=i%>;
    output mem_feat_rst<%=i%>;
    output [FACCUM-1:0] mem_feat_addr<%=i%>;
    output [FACCUM-1:0] mem_feat_addr<%=i%>_d1;
    output conv_we<%=i%>;
    output pool_we<%=i%>;
    output mem_output_we<%=i%>;
    output [OUTSIZE-1:0] mem_output_addr<%=i%>;
    <%- end -%>

    /*AUTOWIRE*/
    wire wreg_start;
    wire wreg_valid;
    wire wreg_end;
    wire conv_start;
    wire conv_valid;
    wire conv_end;
    wire pool_start;
    wire pool_valid;
    wire pool_end;

    /*AUTOREG*/
    reg r_ack;
    reg r_wreg_we;
    reg [1:0] r_state;
    reg [INSIZE-1:0] r_in_addr;
    reg [WSIZE-1:0]  r_w_addr;
    reg [LWIDTH-1:0] r_img_w;
    reg [LWIDTH-1:0] r_img_h;
    reg [LWIDTH-1:0] r_fil_w;
    reg [LWIDTH-1:0] r_fil_h;
    reg [LWIDTH-1:0] r_fea_w;
    reg [LWIDTH-1:0] r_fea_h;
    reg [LWIDTH-1:0] r_wreg_x;
    reg [LWIDTH-1:0] r_wreg_y;
    reg [LWIDTH-1:0] r_conv_x;
    reg [LWIDTH-1:0] r_conv_y;
    reg [LWIDTH-1:0] r_pool_x;
    reg [LWIDTH-1:0] r_pool_y;
    reg [LWIDTH-1:0] r_total_in;
    reg [LWIDTH-1:0] r_total_out;
    reg [LWIDTH-1:0] r_count_in;
    reg [LWIDTH-1:0] r_count_out;
    <%- for i in 0...$core -%>
    reg r_feat_we<%=i%>;
    reg r_feat_rst<%=i%>;
    reg [FACCUM-1:0] r_feat_addr<%=i%>;
    reg [FACCUM-1:0] r_feat_addr<%=i%>_d1;
    reg r_conv_we<%=i%>;
    reg r_pool_we<%=i%>;
    reg r_pool_we<%=i%>_d1;
    reg r_pool_we<%=i%>_d2;
    reg r_pool_we<%=i%>_d3;
    reg [OUTSIZE-1:0] r_output_addr<%=i%>;
    <%- end -%>

    //main FSM
    always @(posedge clk or negedge xrst)
        if (!xrst)
        begin
            r_state <= WAIT;
            r_count_in <= 0;
            r_count_out <= 0;
        end
        else
            case (r_state)
                WAIT:
                    if (req)
                        r_state <= WREG;

                WREG:
                    if (wreg_end)
                        if (r_count_in == r_total_in - 1)
                            r_state <= POOL;
                        else
                            r_state <= CONV;

                CONV:
                    if (conv_end)
                    begin
                        r_state  <= WREG;
                        r_count_in <= r_count_in + 1;
                    end

                POOL:
                    if (pool_end)
                        if (r_count_out + <%=$core%> < r_total_out)
                        begin
                            r_state <= WREG;
                            r_count_in <= 0;
                            r_count_out <= r_count_out + <%=$core%>;
                        end
                        else
                        begin
                            r_state <= WAIT;
                            r_count_in <= 0;
                            r_count_out <= 0;
                        end
            endcase

    //wait exec (initialize)
    always @(posedge clk or negedge xrst)
        if (!xrst)
        begin
            r_total_in  <= 0;
            r_total_out <= 0;
            r_img_w <= 0;
            r_img_h <= 0;
            r_fil_w <= 0;
            r_fil_h <= 0;
            r_fea_w <= 0;
            r_fea_h <= 0;
        end
        else if (r_state == WAIT && req)
        begin
            r_total_in  <= n_in;
            r_total_out <= n_out;
            r_img_w <= img_w;
            r_img_h <= img_h;
            r_fil_w <= fil_w;
            r_fil_h <= fil_h;
            r_fea_w <= img_w - fil_w + 1;
            r_fea_h <= img_h - fil_h + 1;
        end

    assign mem_input_addr = (r_state == CONV || r_state == POOL)
                            ? r_in_addr + 1
                            : r_in_addr;

    always @(posedge clk or negedge xrst)
        if (!xrst)
            r_in_addr <= 0;
        else if (r_state == WAIT && req == 1 || pool_end)
            r_in_addr <= in_addr;
        else if (r_state == CONV || r_state == POOL)
            r_in_addr <= r_in_addr + 1;

    <%- for i in 0...$core -%>
    assign mem_weight_addr<%=i%> = r_state == WREG
                                    ? r_w_addr + 1
                                    : r_w_addr;

    assign wreg_we<%=i%> = wreg_valid;
    <%- end -%>

    always @(posedge clk or negedge xrst)
        if (!xrst)
            r_w_addr <= 0;
        else if (r_state == WAIT && req == 1 || ack)
            r_w_addr <= w_addr;
        else if (r_state == WREG)
            r_w_addr <= r_w_addr + 1;

    //always @(posedge clk or negedge xrst)
    always @(posedge clk)
        if (wreg_valid)
            r_wreg_we <= 1;
        else
            r_wreg_we <= 0;

    //convwreg write
    always @(posedge clk or negedge xrst)
        if (!xrst)
            r_wreg_x <= 0;
        else if (r_state == WAIT)
            r_wreg_x <= 0;
        else if (r_state == WREG)
            if (r_wreg_x == r_fil_w - 1)
                r_wreg_x <= 0;
            else
                r_wreg_x <= r_wreg_x + 1;

    always @(posedge clk or negedge xrst)
        if (!xrst)
            r_wreg_y <= 0;
        else if (r_state == WAIT)
            r_wreg_y <= 0;
        else if (r_state == WREG && r_wreg_x == r_fil_w - 1)
            if (r_wreg_y == r_fil_h - 1)
                r_wreg_y <= 0;
            else
                r_wreg_y <= r_wreg_y + 1;

    assign wreg_start = (r_state == WREG
                        && r_wreg_x == 0 && r_wreg_y == 0);

    assign wreg_valid = (r_state == WREG
                        && r_wreg_x >= 0 && r_wreg_x < r_fil_w
                        && r_wreg_y >=0 && r_wreg_y < r_fil_h);

    assign wreg_end   = (r_state == WREG
                        && r_wreg_x == r_fil_w - 1 && r_wreg_y == r_fil_h - 1);

    //conv exec
    always @(posedge clk or negedge xrst)
        if (!xrst)
            r_conv_x <= 0;
        else if (r_state == WAIT)
            r_conv_x <= 0;
        else if ((r_state == CONV || r_state == POOL))
            if (r_conv_x == r_img_w - 1)
                r_conv_x <= 0;
            else
                r_conv_x <= r_conv_x + 1;

    always @(posedge clk or negedge xrst)
        if (!xrst)
            r_conv_y <= 0;
        else if (r_state == WAIT)
            r_conv_y <= 0;
        else if ((r_state == CONV || r_state == POOL) && r_conv_x == r_img_w - 1)
            if (r_conv_y == r_img_h - 1)
                r_conv_y <= 0;
            else
                r_conv_y <= r_conv_y + 1;

    assign conv_start = (r_state == CONV || r_state == POOL)
                        && r_conv_x == r_fil_w - 1 && r_conv_y == r_fil_h - 1;
    assign conv_valid = (r_state == CONV || r_state == POOL)
                        && r_conv_x >= r_fil_w - 1 && r_conv_x < r_img_w
                        && r_conv_y >= r_fil_h - 1 && r_conv_y < r_img_h;
    assign conv_end   = (r_state == CONV || r_state == POOL)
                        && r_conv_x == r_img_w - 1 && r_conv_y == r_img_h - 1;

    //accum exec
    <%- for i in 0...$core -%>
    assign mem_feat_we<%=i%>      = r_feat_we<%=i%>;
    assign mem_feat_rst<%=i%>     = r_feat_rst<%=i%>;
    assign mem_feat_addr<%=i%>_d1 = r_feat_addr<%=i%>_d1;
    assign mem_feat_addr<%=i%>    = r_feat_addr<%=i%>;
    assign conv_we<%=i%>          = r_conv_we<%=i%>;

    //always @(posedge clk or negedge xrst)
    always @(posedge clk)
        if (r_state == CONV && conv_valid)
            r_feat_we<%=i%> <= 1;
        else
            r_feat_we<%=i%> <= 0;

    //always @(posedge clk or negedge xrst)
    always @(posedge clk)
        if (r_state == CONV && conv_valid && r_count_in == 0)
            r_feat_rst<%=i%> <= 1;
        else
            r_feat_rst<%=i%> <= 0;

    always @(posedge clk or negedge xrst)
        if (!xrst)
            r_feat_addr<%=i%>_d1 <= 0;
        else
            r_feat_addr<%=i%>_d1 <= r_feat_addr<%=i%>;

    always @(posedge clk or negedge xrst)
        if (!xrst)
            r_feat_addr<%=i%> <= 0;
        else if (conv_end)
            r_feat_addr<%=i%> <= 0;
        else if (conv_valid)
            r_feat_addr<%=i%> <= r_feat_addr<%=i%> + 1;

    //always @(posedge clk or negedge xrst)
    always @(posedge clk)
        if (r_state == POOL && conv_valid)
            r_conv_we<%=i%> <= 1;
        else
            r_conv_we<%=i%> <= 0;
    <%- end -%>

    always @(posedge clk or negedge xrst)
        if (!xrst)
            r_pool_x <= 0;
        else if (r_state == WAIT)
            r_pool_x <= 0;
        else if (r_state == POOL && conv_valid)
            if (r_pool_x == r_fea_w - 1)
                r_pool_x <= 0;
            else
                r_pool_x <= r_pool_x + 1;

    always @(posedge clk or negedge xrst)
        if (!xrst)
            r_pool_y <= 0;
        else if (r_state == WAIT)
            r_pool_y <= 0;
        else if (r_state == POOL && conv_valid && r_pool_x == r_fea_w - 1)
            if (r_pool_y == r_fea_h - 1)
                r_pool_y <= 0;
            else
                r_pool_y <= r_pool_y + 1;

    assign pool_start = r_state == POOL
                        && r_pool_x == 1 && r_pool_y == 1;

    assign pool_valid = r_state == POOL
                        && r_pool_x >= 1 && r_pool_x < r_fea_w
                        && r_pool_y >= 1 && r_pool_y < r_fea_h;

    assign pool_end   = r_state == POOL
                        && r_pool_x == r_fea_w - 1 && r_pool_y == r_fea_h - 1;

    //pool exec
    <%- for i in 0...$core -%>
    assign pool_we<%=i%>         = r_pool_we<%=i%>_d2;
    assign mem_output_we<%=i%>   = r_pool_we<%=i%>_d3;
    assign mem_output_addr<%=i%> = r_output_addr<%=i%>;

    //always @(posedge clk or negedge xrst)
    always @(posedge clk)
        if (pool_valid && r_pool_x[0] == 1 && r_pool_y[0] == 1)
            r_pool_we<%=i%> <= 1;
        else
            r_pool_we<%=i%> <= 0;

    always @(posedge clk or negedge xrst)
        if (!xrst)
        begin
            r_pool_we<%=i%>_d1 <= 0;
            r_pool_we<%=i%>_d2 <= 0;
            r_pool_we<%=i%>_d3 <= 0;
        end
        else
        begin
            r_pool_we<%=i%>_d1 <= r_pool_we<%=i%>;
            r_pool_we<%=i%>_d2 <= r_pool_we<%=i%>_d1;
            r_pool_we<%=i%>_d3 <= r_pool_we<%=i%>_d2;
        end

    always @(posedge clk or negedge xrst)
        if (!xrst)
            r_output_addr<%=i%> <= 0;
        else if (mem_output_we<%=i%>)
            r_output_addr<%=i%> <= r_output_addr<%=i%> + 1;
    <%- end -%>

    assign ack = pool_end && r_count_out + <%=$core%> >= r_total_out;

endmodule
